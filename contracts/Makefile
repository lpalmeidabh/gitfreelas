# Makefile para GitFreelas Smart Contracts
.PHONY: help build test deploy verify clean install update

# Cores para output
GREEN := \033[0;32m
YELLOW := \033[1;33m
RED := \033[0;31m
NC := \033[0m # No Color

help: ## üìö Mostra esta ajuda
	@echo "$(GREEN)GitFreelas Smart Contracts - Comandos Dispon√≠veis:$(NC)"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "$(YELLOW)%-25s$(NC) %s\n", $$1, $$2}'

# ============================================================================
# SETUP & DEPENDENCIES
# ============================================================================

install: ## üì¶ Instala depend√™ncias do Foundry
	@echo "$(GREEN)Instalando depend√™ncias...$(NC)"
	forge install

update: ## üîÑ Atualiza depend√™ncias
	@echo "$(GREEN)Atualizando depend√™ncias...$(NC)"
	forge update

# ============================================================================
# BUILD & TEST
# ============================================================================

build: ## üî® Compila os contratos
	@echo "$(GREEN)Compilando contratos...$(NC)"
	forge build

test: ## üß™ Executa todos os testes
	@echo "$(GREEN)Executando testes...$(NC)"
	forge test -vv

test-gas: ## ‚õΩ Executa testes com relat√≥rio de gas
	@echo "$(GREEN)Executando testes com relat√≥rio de gas...$(NC)"
	forge test --gas-report

test-coverage: ## üìä Gera relat√≥rio de cobertura
	@echo "$(GREEN)Gerando relat√≥rio de cobertura...$(NC)"
	forge coverage --report lcov

test-single: ## üéØ Executa um teste espec√≠fico (uso: make test-single TEST=test_name)
	@echo "$(GREEN)Executando teste: $(TEST)$(NC)"
	forge test --match-test $(TEST) -vvv

clean: ## üßπ Limpa arquivos de build
	@echo "$(GREEN)Limpando arquivos de build...$(NC)"
	forge clean
	rm -rf broadcasts/
	rm -rf cache/
	rm -rf out/


# ============================================================================
# ABI EXTRACTION & FRONTEND INTEGRATION
# ============================================================================

extract-abi: ## üìã Extrai ABI do contrato para o frontend
	@echo "$(GREEN)Extraindo ABI do contrato...$(NC)"
	@if [ ! -f out/GitFreelas.sol/GitFreelas.json ]; then \
		echo "$(RED)‚ùå Contrato n√£o compilado! Execute 'make build' primeiro$(NC)"; exit 1; \
	fi
	@mkdir -p ../src/lib/web3/abis
	@echo "$(GREEN)üìÑ Criando GitFreelas.json...$(NC)"
	@cat out/GitFreelas.sol/GitFreelas.json | jq '.abi' > ../src/lib/web3/abis/GitFreelas.json
	@echo "$(GREEN)üìÑ Criando GitFreelas.ts...$(NC)"
	@printf "// Auto-generated by 'make extract-abi' - DO NOT EDIT MANUALLY\n// To update: cd contracts && make extract-abi\n\nexport const GitFreelasABI = " > ../src/lib/web3/abis/GitFreelas.ts
	@cat out/GitFreelas.sol/GitFreelas.json | jq -c '.abi' | tr -d '\n' >> ../src/lib/web3/abis/GitFreelas.ts
	@printf " as const\n" >> ../src/lib/web3/abis/GitFreelas.ts
	@echo "$(GREEN)‚úÖ ABI extra√≠da com sucesso!$(NC)"
	@echo "$(YELLOW)üìÅ Arquivos criados:$(NC)"
	@echo "   - ../src/lib/web3/abis/GitFreelas.json"
	@echo "   - ../src/lib/web3/abis/GitFreelas.ts"

update-frontend: ## üîÑ Atualiza endere√ßo do contrato no frontend
	@echo "$(GREEN)Atualizando endere√ßo do contrato no frontend...$(NC)"
	@if [ -z "$(CONTRACT_ADDRESS)" ]; then \
		echo "$(RED)‚ùå CONTRACT_ADDRESS n√£o fornecido! Use: make update-frontend CONTRACT_ADDRESS=0x...$(NC)"; exit 1; \
	fi
	@if [ ! -f ../.env ]; then \
		echo "$(YELLOW)‚ö†Ô∏è  Criando .env na raiz...$(NC)"; \
		touch ../.env; \
	fi
	@grep -v "NEXT_PUBLIC_GITFREELAS_CONTRACT_ADDRESS" ../.env > ../.env.tmp || true
	@echo "NEXT_PUBLIC_GITFREELAS_CONTRACT_ADDRESS=$(CONTRACT_ADDRESS)" >> ../.env.tmp
	@mv ../.env.tmp ../.env
	@echo "$(GREEN)‚úÖ Endere√ßo atualizado: $(CONTRACT_ADDRESS)$(NC)"

build-and-extract: ## üî®üìã Compila contrato E extrai ABI
	@echo "$(GREEN)Compilando contrato e extraindo ABI...$(NC)"
	@$(MAKE) build
	@$(MAKE) extract-abi

deploy-and-update: ## üöÄüîÑ Deploy completo + atualiza√ß√£o do frontend
	@echo "$(GREEN)Deploy completo com atualiza√ß√£o do frontend...$(NC)"
	@$(MAKE) deploy-sepolia
	@echo "$(YELLOW)üìã Verificando logs de deploy para extrair endere√ßo...$(NC)"
	@CONTRACT_ADDR=$$(cat broadcasts/Deploy.s.sol/11155111/run-latest.json | jq -r '.transactions[0].contractAddress') && \
	if [ "$$CONTRACT_ADDR" != "null" ] && [ "$$CONTRACT_ADDR" != "" ]; then \
		echo "$(GREEN)üìç Contrato deployado em: $$CONTRACT_ADDR$(NC)"; \
		$(MAKE) update-frontend CONTRACT_ADDRESS=$$CONTRACT_ADDR; \
		$(MAKE) extract-abi; \
		echo "$(GREEN)üéâ Deploy completo! Frontend atualizado!$(NC)"; \
	else \
		echo "$(RED)‚ùå N√£o foi poss√≠vel extrair endere√ßo do contrato$(NC)"; \
		echo "$(YELLOW)Execute manualmente: make update-frontend CONTRACT_ADDRESS=0x8A89fc1ab04273fb4d31b101207231cB2dFdd6ED$(NC)"; \
	fi

# ============================================================================
# FRONTEND HELPERS
# ============================================================================

frontend-setup: ## üéØ Setup completo do frontend (ABI + endere√ßos)
	@echo "$(GREEN)Configurando frontend completo...$(NC)"
	@$(MAKE) extract-abi
	@echo "$(YELLOW)üìã Verificar se as vari√°veis est√£o no .env:$(NC)"
	@echo "   - NEXT_PUBLIC_ALCHEMY_API_KEY"
	@echo "   - NEXT_PUBLIC_GITFREELAS_CONTRACT_ADDRESS"
	@echo "   - NEXT_PUBLIC_DEFAULT_CHAIN_ID"

check-frontend: ## üîç Verifica configura√ß√£o do frontend
	@echo "$(GREEN)Verificando configura√ß√£o do frontend...$(NC)"
	@if [ ! -f ../src/lib/web3/abis/GitFreelas.ts ]; then \
		echo "$(RED)‚ùå ABI n√£o encontrada! Execute: make extract-abi$(NC)"; \
	else \
		echo "$(GREEN)‚úÖ ABI encontrada$(NC)"; \
	fi
	@if [ ! -f ../.env ]; then \
		echo "$(RED)‚ùå .env n√£o encontrado na raiz!$(NC)"; \
	else \
		echo "$(GREEN)‚úÖ .env encontrado$(NC)"; \
		if grep -q "NEXT_PUBLIC_GITFREELAS_CONTRACT_ADDRESS" ../.env; then \
			echo "$(GREEN)‚úÖ CONTRACT_ADDRESS configurado$(NC)"; \
		else \
			echo "$(YELLOW)‚ö†Ô∏è  CONTRACT_ADDRESS n√£o configurado$(NC)"; \
		fi; \
		if grep -q "NEXT_PUBLIC_ALCHEMY_API_KEY" ../.env; then \
			echo "$(GREEN)‚úÖ ALCHEMY_API_KEY configurado$(NC)"; \
		else \
			echo "$(YELLOW)‚ö†Ô∏è  ALCHEMY_API_KEY n√£o configurado$(NC)"; \
		fi; \
	fi


# ============================================================================
# DEVELOPMENT
# ============================================================================

anvil: ## üîß Inicia node local do Foundry
	@echo "$(GREEN)Iniciando Anvil (node local)...$(NC)"
	anvil --host 0.0.0.0 --port 8545

format: ## üíÑ Formata c√≥digo Solidity
	@echo "$(GREEN)Formatando c√≥digo...$(NC)"
	forge fmt

snapshot: ## üì∏ Cria snapshot dos custos de gas
	@echo "$(GREEN)Criando snapshot de gas...$(NC)"
	forge snapshot

# ============================================================================
# LOCAL DEPLOYMENT
# ============================================================================

deploy-local: ## üöÄ Deploy no node local (Anvil)
	@echo "$(GREEN)Fazendo deploy no node local...$(NC)"
	@if [ ! -f .env ]; then echo "$(RED)‚ùå Arquivo .env n√£o encontrado!$(NC)"; exit 1; fi
	forge script script/Deploy.s.sol \
		--rpc-url localhost \
		--broadcast \
		--private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80

# ============================================================================
# TESTNET DEPLOYMENT
# ============================================================================

deploy-sepolia: ## üåê Deploy na Sepolia testnet
	@echo "$(GREEN)Fazendo deploy na Sepolia...$(NC)"
	@if [ ! -f .env ]; then echo "$(RED)‚ùå Arquivo .env n√£o encontrado!$(NC)"; exit 1; fi
	@if [ -z "$(PRIVATE_KEY)" ]; then echo "$(RED)‚ùå PRIVATE_KEY n√£o configurada!$(NC)"; exit 1; fi
	forge script script/Deploy.s.sol \
		--rpc-url sepolia \
		--broadcast \
		--verify \
		--slow \
		--etherscan-api-key $(ETHERSCAN_API_KEY)

verify-sepolia: ## ‚úÖ Verifica contrato na Sepolia
	@echo "$(GREEN)Verificando contrato na Sepolia...$(NC)"
	@if [ -z "$(CONTRACT_ADDRESS)" ]; then echo "$(RED)‚ùå CONTRACT_ADDRESS n√£o fornecido! Use: make verify-sepolia CONTRACT_ADDRESS=0x...$(NC)"; exit 1; fi
	forge verify-contract $(CONTRACT_ADDRESS) \
		src/GitFreelas.sol:GitFreelas \
		--chain-id 11155111 \
		--etherscan-api-key $(ETHERSCAN_API_KEY) \
		--watch

# ============================================================================
# MAINNET DEPLOYMENT (PRODU√á√ÉO)
# ============================================================================

deploy-mainnet: ## üî¥ Deploy na mainnet (CUIDADO!)
	@echo "$(RED)‚ö†Ô∏è  DEPLOY EM MAINNET! Confirme que est√° tudo correto.$(NC)"
	@echo "$(YELLOW)Pressione Ctrl+C para cancelar em 10 segundos...$(NC)"
	@sleep 10
	@read -p "Digite 'DEPLOY_MAINNET_CONFIRMED' para continuar: " confirm; \
	if [ "$$confirm" != "DEPLOY_MAINNET_CONFIRMED" ]; then \
		echo "$(RED)‚ùå Deploy cancelado.$(NC)"; exit 1; \
	fi
	@echo "$(GREEN)Fazendo deploy na mainnet...$(NC)"
	forge script script/Deploy.s.sol \
		--rpc-url mainnet \
		--broadcast \
		--verify \
		--slow \
		--etherscan-api-key $(ETHERSCAN_API_KEY)

# ============================================================================
# UTILITIES
# ============================================================================

check-env: ## üîç Verifica configura√ß√µes do .env
	@echo "$(GREEN)Verificando configura√ß√µes...$(NC)"
	@if [ ! -f .env ]; then echo "$(RED)‚ùå Arquivo .env n√£o encontrado!$(NC)"; exit 1; fi
	@echo "$(GREEN)‚úÖ Arquivo .env encontrado$(NC)"
	@source .env && \
	if [ -z "$$PRIVATE_KEY" ]; then echo "$(YELLOW)‚ö†Ô∏è  PRIVATE_KEY n√£o configurada$(NC)"; fi && \
	if [ -z "$$ETHERSCAN_API_KEY" ]; then echo "$(YELLOW)‚ö†Ô∏è  ETHERSCAN_API_KEY n√£o configurada$(NC)"; fi && \
	if [ -z "$$ALCHEMY_API_KEY" ]; then echo "$(YELLOW)‚ö†Ô∏è  ALCHEMY_API_KEY n√£o configurada$(NC)"; fi

flatten: ## üìã Cria arquivo √∫nico (flattened) do contrato
	@echo "$(GREEN)Criando arquivo flattened...$(NC)"
	forge flatten src/GitFreelas.sol > GitFreelas_flattened.sol
	@echo "$(GREEN)‚úÖ Arquivo criado: GitFreelas_flattened.sol$(NC)"

estimate-gas: ## ‚õΩ Estima gas para deploy
	@echo "$(GREEN)Estimando gas para deploy...$(NC)"
	forge script script/Deploy.s.sol --rpc-url sepolia

# ============================================================================
# INFORMATION
# ============================================================================

info: ## ‚ÑπÔ∏è  Mostra informa√ß√µes do projeto
	@echo "$(GREEN)GitFreelas Smart Contracts$(NC)"
	@echo "================================"
	@echo "Solidity version: $(shell forge --version | head -n 1)"
	@echo "Contracts: $(shell find src -name "*.sol" | wc -l)"
	@echo "Tests: $(shell find test -name "*.sol" | wc -l)"
	@echo "Scripts: $(shell find script -name "*.sol" | wc -l)"
	@echo ""
	@echo "$(YELLOW)Use 'make help' para ver todos os comandos dispon√≠veis$(NC)"

# Include .env if it exists
ifneq (,$(wildcard .env))
include .env
export
endif

# Default target
.DEFAULT_GOAL := help